<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RELQ: GLITCH REAPER</title>
<style>
  :root{--bg:#07090b;--fg:#e7e7e7;--red:#ff1a1a;--green:#00ff88;--muted:#99a1a8}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  #wrap{position:fixed;inset:0;display:grid;place-items:center;z-index:0}
  canvas{width:100vw;height:100vh;display:block;background:radial-gradient(1200px 800px at 50% 50%, #0a0f12 0%, #050608 60%, #030406 100%)}
  .hud{position:fixed;inset:0;pointer-events:none;z-index:5}
  .bar{position:absolute;left:20px;top:20px;display:flex;gap:12px;align-items:center;font-weight:600;letter-spacing:.4px}
  .chip{background:rgba(255,255,255,.06);padding:8px 12px;border-radius:14px;box-shadow:0 0 0 1px rgba(255,255,255,.06),0 4px 18px rgba(0,0,0,.4)}
  .chip .k{color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:1px}
  .chip .v{font-size:14px;font-weight:700}
  .overlay{position:fixed;inset:0;display:grid;place-items:center;z-index:10;background:linear-gradient(180deg,rgba(10,12,16,.88),rgba(6,7,10,.88));backdrop-filter:blur(6px)}
  .panel{width:min(700px,92vw);background:rgba(20,22,26,.85);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:22px;box-shadow:0 30px 60px rgba(0,0,0,.55)}
  .title{display:flex;align-items:center;gap:14px;font-size:26px;font-weight:800;letter-spacing:.6px}
  .title .dot{width:10px;height:10px;border-radius:20px;background:var(--red);box-shadow:0 0 14px var(--red);animation:pulse 1.8s infinite}
  @keyframes pulse{0%,100%{transform:scale(.9)}50%{transform:scale(1.2)}}
  .subtitle{margin-top:6px;color:#aab3bd;font-size:14px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:18px}
  .card{background:rgba(255,255,255,.04);border-radius:14px;padding:14px;border:1px solid rgba(255,255,255,.06)}
  .card h4{margin:0 0 8px 0;font-size:13px;color:#c5cdd7;text-transform:uppercase;letter-spacing:1px}
  ul{margin:0;padding-left:18px;color:#d9dee3}
  .actions{display:flex;gap:12px;margin-top:18px}
  .btn{pointer-events:auto;cursor:pointer;user-select:none;padding:12px 16px;border-radius:12px;font-weight:800;letter-spacing:.6px;text-transform:uppercase;border:1px solid rgba(255,255,255,.1);background:linear-gradient(180deg,#12161a,#0c0f12);color:var(--fg);box-shadow:0 10px 30px rgba(0,0,0,.5);transition:transform .08s}
  .btn:hover{transform:translateY(-1px)}
  .btn.primary{background:linear-gradient(180deg,#1b0b0b,#0d0606);border-color:rgba(255,26,26,.4);box-shadow:0 0 0 1px rgba(255,26,26,.2),0 18px 60px rgba(255,26,26,.15)}
  .footer{margin-top:10px;color:#a7b0b8;font-size:12px}
  .kbd{background:#111418;border:1px solid rgba(255,255,255,.12);padding:2px 6px;border-radius:6px;font-weight:700;font-size:12px}
  .hidden{display:none}
</style>
</head>
<body>
  <div id="wrap"><canvas id="game" width="1280" height="720"></canvas></div>

  <div class="hud"><div class="bar">
    <div class="chip"><span class="k">Score</span> <span class="v" id="score">0</span></div>
    <div class="chip"><span class="k">Kills</span> <span class="v" id="kills">0</span></div>
    <div class="chip"><span class="k">HP</span> <span class="v" id="hp">100</span></div>
    <div class="chip"><span class="k">High Score</span> <span class="v" id="hi">0</span></div>
  </div></div>

  <!-- START -->
  <div class="overlay" id="start"><div class="panel">
    <div class="title"><span class="dot"></span> RELQ: GLITCH REAPER</div>
    <div class="subtitle">Back to the original vibe — matrix rain, bots, and your Relq character.</div>
    <div class="grid">
      <div class="card"><h4>Controls</h4><ul>
        <li><span class="kbd">WASD</span> / <span class="kbd">Arrows</span> — Move</li>
        <li><span class="kbd">Mouse</span> — Aim</li>
        <li><span class="kbd">Hold Left-Click</span> or <span class="kbd">Hold Space</span> — Throw scythe (rate-limited)</li>
        <li><span class="kbd">P</span> Pause • <span class="kbd">R</span> Restart • <span class="kbd">Esc</span> Menu • <span class="kbd">M</span> Mute</li>
      </ul></div>
      <div class="card"><h4>Tips</h4><ul>
        <li>Kite bots into lines; slice through for multi-kills.</li>
        <li>Scythe flies straight and despawns off-screen.</li>
        <li>Difficulty ramps every 20s.</li>
      </ul></div>
    </div>
    <div class="actions">
      <button class="btn primary" id="btnStart">Start</button>
      <button class="btn" id="btnPractice">Practice (No Score)</button>
      <button class="btn" id="btnToggleSound">Sound: <span id="soundState">On</span></button>
    </div>
    <div class="footer">HTML5 Canvas • No external libs</div>
  </div></div>

  <!-- OVER -->
  <div class="overlay hidden" id="over"><div class="panel">
    <div class="title"><span class="dot"></span> Defeated</div>
    <div class="subtitle">The grid eats another soul. Try again?</div>
    <div class="grid">
      <div class="card"><h4>Run Stats</h4><ul>
        <li>Score: <span id="oScore">0</span></li>
        <li>Kills: <span id="oKills">0</span></li>
        <li>Survival: <span id="oTime">0s</span></li>
        <li>High Score: <span id="oHi">0</span></li>
      </ul></div>
      <div class="card"><h4>Hotkeys</h4><ul>
        <li><span class="kbd">R</span> Restart</li>
        <li><span class="kbd">Esc</span> Menu</li>
        <li><span class="kbd">M</span> Mute/Unmute</li>
      </ul></div>
      <div class="card"><h4>Scoreboard (Top 5)</h4><ul id="scoreList"><li>No scores yet.</li></ul></div>
    </div>
    <div class="actions">
      <button class="btn primary" id="btnRestart">Restart</button>
      <button class="btn" id="btnMenu">Main Menu</button>
    </div>
  </div></div>

<script>
/* ---------- Config (only edit path/size if needed) ---------- */
const SPRITE_URL   = 'relq-sprite.png'; // put this PNG next to index.html
const SPRITE_SCALE = 0.08;              // overall player size
const EYE_OFFSET_L = {x:-10,y:-6};      // glow offsets to line up with your art
const EYE_OFFSET_R = {x: 10,y:-6};
const FIRE_COOLDOWN = 0.18;
const PLAYER_SPEED  = 340;

/* ---------- Helpers ---------- */
const qs=s=>document.querySelector(s);
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const rand=(a,b)=>Math.random()*(b-a)+a;
const randInt=(a,b)=>Math.floor(rand(a,b));
const TAU=Math.PI*2;

const canvas=qs('#game'), ctx=canvas.getContext('2d');
const hud={score:qs('#score'),kills:qs('#kills'),hp:qs('#hp'),hi:qs('#hi')};
const overlays={start:qs('#start'),over:qs('#over'),oScore:qs('#oScore'),oKills:qs('#oKills'),oTime:qs('#oTime'),oHi:qs('#oHi')};
const scoreList=qs('#scoreList');

let W=1280,H=720,DPR=1;

/* ---------- Minimal SFX ---------- */
const AudioKit=(()=>{let ctxA,muted=false;
  function ensure(){try{ctxA=ctxA||new (window.AudioContext||window.webkitAudioContext)();}catch(e){}}
  function tone({f=560,t=.045,type='sawtooth',v=.1,slide=.7}){if(muted||!window.AudioContext)return;ensure();
    const o=ctxA.createOscillator(),g=ctxA.createGain();o.type=type;o.frequency.value=f;o.connect(g);g.connect(ctxA.destination);
    const now=ctxA.currentTime;g.gain.setValueAtTime(v,now);g.gain.exponentialRampToValueAtTime(0.0001,now+t);
    if(slide)o.frequency.exponentialRampToValueAtTime(Math.max(40,f*slide),now+t);o.start();o.stop(now+t);}
  return{play(n){if(n==='throw')tone({});else if(n==='kill')tone({f:420,type:'triangle',t:.09,slide:.4,v:.12});
                 else if(n==='hurt')tone({f:110,type:'sine',t:.12,v:.16});else if(n==='over')tone({f:90,type:'square',t:.4,v:.12});},
         toggle(){muted=!muted;const el=qs('#soundState');if(el)el.textContent=muted?'Off':'On';},isMuted(){return muted}}
})();

/* ---------- Input ---------- */
const keys=new Set(); const mouse={x:W/2,y:H/2,down:false};
addEventListener('keydown',e=>{const k=e.key.toLowerCase();keys.add(k);
  if([' ','arrowup','arrowdown','arrowleft','arrowright'].includes(k)) e.preventDefault();
  if(k==='p') togglePause(); if(k==='r') restart(); if(k==='m') AudioKit.toggle(); if(e.key==='Escape') showMenu();
});
addEventListener('keyup',e=>keys.delete(e.key.toLowerCase()));
addEventListener('mousemove',e=>{mouse.x=e.clientX;mouse.y=e.clientY;});
addEventListener('mousedown',()=>{mouse.down=true;});
addEventListener('mouseup',()=>{mouse.down=false;});

/* ---------- State ---------- */
const STATE={MENU:0,PLAY:1,PRACTICE:2,PAUSE:3,OVER:4}; let state=STATE.MENU;
let score=0,kills=0,hp=100,hi=0; try{hi=parseInt(localStorage.getItem('relq_hi')||'0')}catch(e){hi=0} hud.hi.textContent=hi;
let tStart=0,tNow=0,last=0,dt=0;

/* ---------- Player (Relq sprite) ---------- */
const player={x:W/2,y:H/2,r:22,speed:PLAYER_SPEED,angle:0,breath:0};
const relqImg=new Image(); relqImg.src=SPRITE_URL; let relqReady=false; relqImg.onload=()=>relqReady=true;
function resetPlayer(){ player.x=W/2; player.y=H/2; player.angle=0; player.breath=0; hp=100; }

function drawPlayer(){
  const px=player.x, py=player.y;

  // red aura
  const grad=ctx.createRadialGradient(px,py,10,px,py,140);
  grad.addColorStop(0,'rgba(255,0,0,0.14)'); grad.addColorStop(1,'rgba(255,0,0,0)'); ctx.fillStyle=grad;
  ctx.beginPath(); ctx.arc(px,py,140,0,TAU); ctx.fill();

  // breathing
  player.breath += dt; const breathe = 1 + Math.sin(player.breath*2.2)*0.03;

  // shadow
  ctx.save(); ctx.globalAlpha=0.25; ctx.fillStyle='#000';
  ctx.beginPath(); ctx.ellipse(px, py+18, 22, 10, 0, 0, TAU); ctx.fill(); ctx.restore();

  ctx.save();
  ctx.translate(px,py); ctx.rotate(player.angle); ctx.scale(SPRITE_SCALE*breathe, SPRITE_SCALE*breathe);

  if(relqReady){
    const iw=relqImg.width, ih=relqImg.height;
    ctx.drawImage(relqImg, -iw/2, -ih/2);
  }else{
    // vector fallback while image loads
    ctx.fillStyle='#0f1218'; ctx.beginPath();
    ctx.moveTo(-30,18); ctx.quadraticCurveTo(0,44,30,18); ctx.lineTo(30,-6); ctx.quadraticCurveTo(0,-24,-30,-6);
    ctx.closePath(); ctx.fill(); ctx.strokeStyle='rgba(255,26,26,.6)'; ctx.lineWidth=2; ctx.stroke();
    ctx.fillStyle='#cfd3d6'; ctx.beginPath(); ctx.arc(-4,-10,14,0,TAU); ctx.fill();
  }

  // eye glow
  const blink = 0.9 + Math.sin(performance.now()*0.005)*0.25;
  ctx.globalCompositeOperation='lighter';
  ctx.fillStyle='rgba(255,26,26,0.9)';
  ctx.beginPath(); ctx.ellipse(EYE_OFFSET_L.x, EYE_OFFSET_L.y, 5*blink, 3.0, 0, 0, TAU); ctx.fill();
  ctx.beginPath(); ctx.ellipse(EYE_OFFSET_R.x, EYE_OFFSET_R.y, 5*blink, 3.0, 0, 0, TAU); ctx.fill();
  ctx.globalCompositeOperation='source-over';

  ctx.restore();
}

/* ---------- Scythe shots (no boomerang) ---------- */
const shots=[]; let fireHeld=false, fireTimer=0;
function spawnShot(){ const a=player.angle, c=Math.cos(a), s=Math.sin(a);
  shots.push({x:player.x+c*26,y:player.y+s*26,vx:c*880,vy:s*880,spin:0});
  AudioKit.play('throw');
}
function updateShots(dt){
  fireHeld = mouse.down || keys.has(' ');
  fireTimer = Math.max(0, fireTimer - dt);
  if (fireHeld && fireTimer === 0) { spawnShot(); fireTimer = FIRE_COOLDOWN; }
  for(let i=shots.length-1;i>=0;i--){
    const s=shots[i]; s.x+=s.vx*dt; s.y+=s.vy*dt; s.spin += 12*dt;
    if(s.x<-100||s.y<-100||s.x>W+100||s.y>H+100){ shots.splice(i,1); continue; }
    for(let j=enemies.length-1;j>=0;j--){
      const e=enemies[j]; if(Math.hypot(e.x-s.x,e.y-s.y) < e.r+9){
        enemies.splice(j,1); kills++; score+=30; addParticles(e.x,e.y,'#ff1a1a'); addBlood(e.x,e.y); AudioKit.play('kill'); shots.splice(i,1); break;
      }
    }
  }
}
function drawShots(){
  for(const s of shots){ ctx.save(); ctx.translate(s.x,s.y);
    const ang=Math.atan2(s.vy,s.vx)+s.spin; ctx.rotate(ang);
    ctx.strokeStyle='#c4a67a'; ctx.lineWidth=2.2; ctx.lineCap='round'; ctx.beginPath(); ctx.moveTo(-8,0); ctx.lineTo(8,0); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(8,-2); ctx.quadraticCurveTo(26,-10,42,-4); ctx.quadraticCurveTo(26,8,8,2); ctx.closePath();
    const g=ctx.createLinearGradient(10,-12,56,12); g.addColorStop(0,'#f6f9fc'); g.addColorStop(1,'#c6cdd4'); ctx.fillStyle=g; ctx.fill();
    ctx.shadowColor='rgba(255,26,26,.85)'; ctx.shadowBlur=10; ctx.strokeStyle='rgba(255,26,26,.9)'; ctx.lineWidth=1; ctx.stroke();
    ctx.globalAlpha=.35; ctx.fillStyle='rgba(255,26,26,.35)'; ctx.fillRect(-18,-1,12,2); ctx.restore();
  }
}

/* ---------- Enemies / particles ---------- */
const enemies=[], parts=[], blood=[], stains=[];
function spawnEnemy(near=false){
  const m=Math.max(1,1+Math.floor((tNow-tStart)/20000));
  const speed=rand(70,120)+m*18, size=rand(16,22);
  let x,y,pad=40; if(Math.random()<.5){x=Math.random()<.5?-pad:W+pad;y=rand(0,H);}else{y=Math.random()<.5?-pad:H+pad;x=rand(0,W);}
  if(near){x=clamp(player.x+rand(-260,260),0,W);y=clamp(player.y+rand(-260,260),0,H);}
  const taunts=['reporting','aimbotter','cheater','shadowban him','no recoil?','walling','sus aim','controller abuse','cronus kid'];
  enemies.push({x,y,r:size,spd:speed,t:0,name:'SaltyBot_'+randInt(1000,9999),taunt:taunts[randInt(0,taunts.length)],tauntShow:0,tauntCd:rand(1.5,4)});
}
function spawnBurst(n,near=false){ for(let i=0;i<n;i++) spawnEnemy(near); }
function addParticles(x,y,c){ for(let i=0;i<12;i++) parts.push({x,y,vx:rand(-140,140),vy:rand(-140,140),life:rand(.25,.7),t:0,col:c,sz:rand(2,4)}); }
function addBlood(x,y){ for(let i=0;i<18;i++) blood.push({x,y,vx:rand(-220,220),vy:rand(-40,-260),g:900,life:rand(.35,.9),t:0,sz:rand(2,4)});
  stains.push({x:x+rand(-8,8),y:y+rand(-8,8),r:rand(6,14),a:0.7,t:0}); }
function updateEnemies(dt){
  const px=player.x, py=player.y;
  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i]; e.t+=dt; e.tauntCd-=dt; if(e.tauntShow>0) e.tauntShow-=dt;
    const dx=px-e.x, dy=py-e.y, d=Math.hypot(dx,dy)||1; const ux=dx/d, uy=dy/d; const speed=e.spd*(1+0.1*Math.sin(e.t*3));
    e.x+=ux*speed*dt; e.y+=uy*speed*dt; if(e.tauntCd<=0 && d<260){ e.tauntShow=rand(1.0,1.8); e.tauntCd=rand(2.8,5.5); }
    if(d<e.r+player.r){ enemies.splice(i,1); hp-=10; score=Math.max(0,score-20); addParticles(px,py,'#00ff88'); AudioKit.play('hurt'); if(hp<=0){ gameOver(); return; } }
  }
}
function drawEnemies(){
  for(const e of enemies){ ctx.save(); ctx.translate(e.x,e.y); const s=e.r*1.6;
    ctx.fillStyle='#0f1116'; ctx.strokeStyle='rgba(255,26,26,.35)'; ctx.lineWidth=2;
    if(ctx.roundRect){ ctx.beginPath(); ctx.roundRect(-s*0.45,-s*0.5,s*0.9,s*0.9,6); ctx.fill(); ctx.stroke(); }
    else { ctx.fillRect(-s*0.45,-s*0.5,s*0.9,s*0.9); ctx.strokeRect(-s*0.45,-s*0.5,s*0.9,s*0.9); }
    ctx.beginPath(); ctx.arc(0,-s*0.6,s*0.38,0,TAU); ctx.fillStyle='#12151b'; ctx.fill();
    ctx.fillStyle='#12ff99'; ctx.globalAlpha=.85; ctx.fillRect(-s*0.26,-s*0.64,s*0.52,s*0.18); ctx.globalAlpha=1;
    ctx.fillStyle='rgba(255,255,255,.7)'; ctx.font='12px monospace'; ctx.textAlign='center'; ctx.fillText(e.name,0,s*0.8);
    if(e.tauntShow>0){ const txt=e.taunt.toUpperCase(); const w=Math.max(48, ctx.measureText(txt).width + 16);
      ctx.save(); ctx.translate(0,-s*1.15); ctx.fillStyle='rgba(0,0,0,.7)'; ctx.strokeStyle='rgba(255,26,26,.5)'; ctx.lineWidth=1.5;
      if(ctx.roundRect){ ctx.beginPath(); ctx.roundRect(-w/2,-22,w,20,8); ctx.fill(); ctx.stroke(); }
      else { ctx.fillRect(-w/2,-22,w,20); ctx.strokeRect(-w/2,-22,w,20); }
      ctx.beginPath(); ctx.moveTo(0,-2); ctx.lineTo(6,6); ctx.lineTo(-6,6); ctx.closePath(); ctx.fill();
      ctx.fillStyle='#e6ebef'; ctx.font='11px monospace'; ctx.textAlign='center'; ctx.fillText(txt,0,-8); ctx.restore(); }
    ctx.restore(); }
}

/* ---------- Matrix/code rain ---------- */
const glyphs='ｱｲｳｴｵｶｷｸｹｺｻｼｽｾｿﾀﾁﾂﾃﾄﾅﾆﾇﾈﾉﾊﾋﾌﾍﾎ0123456789<>[]{}#$%&+-*/';
let codeCols=[], colW=16, nCols=0;
function initCode(){ colW=Math.max(14,Math.min(22,Math.round(W/70))); nCols=Math.ceil(W/colW);
  codeCols.length=0; for(let i=0;i<nCols;i++) codeCols.push({y:rand(-H,H),spd:rand(60,180),trail:randInt(8,22)}); }
function drawCode(dt){
  ctx.save(); ctx.globalAlpha=.75; ctx.fillStyle='#06130a'; ctx.fillRect(0,0,W,H); ctx.font='16px monospace';
  for(let i=0;i<nCols;i++){ const c=codeCols[i]; c.y+=c.spd*dt; if(c.y>H+20){ c.y=-rand(40,H*.5); c.spd=rand(60,180); c.trail=randInt(8,22); }
    for(let k=0;k<c.trail;k++){ const y=c.y-k*16; if(y<-20||y>H+20) continue;
      const g=glyphs[randInt(0,glyphs.length)]; ctx.globalAlpha=Math.max(0,1-k/c.trail);
      ctx.fillStyle=`rgba(0,255,136,${0.7-k/(c.trail*1.2)})`; ctx.fillText(g,i*colW+8,y); } }
  ctx.restore();
}

/* ---------- Blood/parts & glitch lines ---------- */
function updateParticles(dt){
  for(let i=parts.length-1;i>=0;i--){ const p=parts[i]; p.t+=dt; p.x+=p.vx*dt; p.y+=p.vy*dt; if(p.t>p.life) parts.splice(i,1); }
  for(let i=blood.length-1;i>=0;i--){ const b=blood[i]; b.t+=dt; b.vy+=b.g*dt; b.x+=b.vx*dt; b.y+=b.vy*dt;
    if(b.y>H-2||b.t>b.life){ stains.push({x:b.x,y:Math.min(b.y,H-2),r:b.sz+rand(1,4),a:0.6,t:0}); blood.splice(i,1); } }
  for(let i=stains.length-1;i>=0;i--){ const s=stains[i]; s.t+=dt; s.a=Math.max(0, s.a-dt*0.02); if(s.a<=0) stains.splice(i,1); }
}
function drawParticles(){
  for(const s of stains){ ctx.fillStyle=`rgba(255,26,26,${0.35*s.a})`; ctx.beginPath(); ctx.ellipse(s.x,s.y,s.r,s.r*0.6,0,0,TAU); ctx.fill(); }
  for(const p of parts){ ctx.fillStyle=p.col; ctx.globalAlpha=1-p.t/p.life; ctx.fillRect(p.x-p.sz/2,p.y-p.sz/2,p.sz,p.sz); }
  for(const b of blood){ ctx.fillStyle='rgba(180,12,12,.85)'; ctx.beginPath(); ctx.arc(b.x,b.y,b.sz,0,TAU); ctx.fill(); }
  ctx.globalAlpha=1;
}
function drawGlitch(){ ctx.save(); ctx.globalAlpha=.05; ctx.fillStyle='#ff1a1a'; for(let i=0;i<6;i++){ const y=rand(0,H),h=rand(1,3); ctx.fillRect(0,y,W,h); } ctx.restore(); }
function drawRelqMark(){ ctx.save(); ctx.globalAlpha=.18; const x=W-200,y=56; ctx.translate(x,y);
  ctx.font='900 42px system-ui,sans-serif'; ctx.fillStyle='#ff1a1a'; ctx.fillText('RELQ',0,0);
  ctx.globalAlpha=.35; ctx.fillStyle='#00ff88'; ctx.fillText('RELQ',rand(-2,2),rand(-2,2));
  ctx.globalAlpha=.22; ctx.fillStyle='#ffffff'; ctx.fillText('RELQ',rand(-1,1),rand(-1,1)); ctx.restore(); }

/* ---------- Sizing & loop ---------- */
function resize(){ DPR=Math.min(2,window.devicePixelRatio||1); W=canvas.clientWidth; H=canvas.clientHeight;
  canvas.width=W*DPR; canvas.height=H*DPR; ctx.setTransform(DPR,0,0,DPR,0,0); initCode(); }
addEventListener('resize',resize,{passive:true}); resize();

let spawnAcc=0, spawnRate=0.9;
function loop(ts){
  if(!last) last=ts; dt=Math.min(.033,(ts-last)/1000); last=ts; tNow=ts;
  if(state===STATE.PLAY||state===STATE.PRACTICE){
    ctx.clearRect(0,0,W,H);
    drawCode(dt);

    // update
    const dx=mouse.x-player.x, dy=mouse.y-player.y; player.angle=Math.atan2(dy,dx);
    let vx=0,vy=0; if(keys.has('w')||keys.has('arrowup'))vy-=1; if(keys.has('s')||keys.has('arrowdown'))vy+=1;
    if(keys.has('a')||keys.has('arrowleft'))vx-=1; if(keys.has('d')||keys.has('arrowright'))vx+=1;
    const m=Math.hypot(vx,vy)||1; vx/=m; vy/=m; player.x=clamp(player.x+vx*player.speed*dt,0,W); player.y=clamp(player.y+vy*player.speed*dt,0,H);

    updateEnemies(dt); updateParticles(dt); updateShots(dt);

    spawnAcc+=dt; const mult=state===STATE.PRACTICE?0.6:1;
    if(spawnAcc>=spawnRate/mult){ spawnAcc=0; spawnEnemy(); if(Math.random()<.35) spawnEnemy(); if(Math.random()<.08) spawnBurst(3,true); }

    drawShots(); drawEnemies(); drawParticles(); drawPlayer(); drawGlitch(); drawRelqMark();

    if(state===STATE.PLAY) score += Math.floor(20*dt);
    hud.score.textContent=score; hud.kills.textContent=kills; hud.hp.textContent=Math.max(0,Math.min(100,hp));
  }
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* ---------- States & scoreboard ---------- */
function startGame(practice=false){
  state = practice ? STATE.PRACTICE : STATE.PLAY;
  overlays.start.classList.add('hidden'); overlays.over.classList.add('hidden');
  score=0; kills=0; hp=100; enemies.length=0; parts.length=0; blood.length=0; stains.length=0; shots.length=0;
  resetPlayer(); spawnBurst(4,false); tStart=performance.now(); last=0; spawnRate=0.9; fireTimer=0;
}
function showMenu(){ state=STATE.MENU; overlays.over.classList.add('hidden'); overlays.start.classList.remove('hidden');
  qs('#start .title').innerHTML='<span class="dot"></span> RELQ: GLITCH REAPER'; }
function gameOver(){ state=STATE.OVER; overlays.start.classList.add('hidden'); overlays.over.classList.remove('hidden');
  overlays.oScore.textContent=score; overlays.oKills.textContent=kills; overlays.oTime.textContent=Math.round((performance.now()-tStart)/1000)+'s';
  try{ hi=Math.max(hi,score); localStorage.setItem('relq_hi', String(hi)); }catch(e){} hud.hi.textContent=hi; overlays.oHi.textContent=hi;
  saveScore(score,kills, Math.round((performance.now()-tStart)/1000)); renderScores(); AudioKit.play('over'); }

function loadScores(){ try{ return JSON.parse(localStorage.getItem('relq_scores')||'[]'); }catch(e){ return []; } }
function saveScore(s,k,t){ const arr=loadScores(); arr.push({score:s,kills:k,time:t,ts:Date.now()}); arr.sort((a,b)=>b.score-a.score);
  try{ localStorage.setItem('relq_scores', JSON.stringify(arr.slice(0,5))); }catch(e){} }
function renderScores(){ if(!scoreList) return; const arr=loadScores().sort((a,b)=>b.score-a.score).slice(0,5);
  scoreList.innerHTML = arr.length ? arr.map((s,i)=>`<li>#${i+1} — ${s.score} pts • ${s.kills} kills • ${s.time}s</li>`).join('') : '<li>No scores yet.</li>'; }
renderScores();

/* ---------- Buttons ---------- */
qs('#btnStart').addEventListener('click',()=>startGame(false));
qs('#btnPractice').addEventListener('click',()=>startGame(true));
qs('#btnRestart').addEventListener('click',()=>restart());
qs('#btnMenu').addEventListener('click',()=>showMenu());
qs('#btnToggleSound').addEventListener('click',()=>AudioKit.toggle());
document.addEventListener('visibilitychange',()=>{ if(document.hidden && !AudioKit.isMuted()) AudioKit.toggle(); });

function restart(){ if(state===STATE.PLAY||state===STATE.PRACTICE||state===STATE.OVER) startGame(state===STATE.PRACTICE); }
function togglePause(){ if(state===STATE.PLAY){ state=STATE.PAUSE; overlays.start.classList.remove('hidden'); qs('#start .title').innerHTML='<span class="dot"></span> Paused'; }
  else if(state===STATE.PAUSE){ startGame(false);} }

/* ---------- Init ---------- */
function resizeKick(){const e=new Event('resize'); window.dispatchEvent(e);} initCode(); showMenu(); resizeKick();
</script>
</body>
</html>


